 <!DOCTYPE html>    
<html>    
<head>    
<meta charset="utf-8">    
<title>微信JS-SDK Demo</title>    
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
</head>    
<body ontouchstart="">    
<div class="wxapi_container">
<div class="lbox_close wxapi_form">
<h3 id="menu-image">图像接口</h3>    
<span class="desc">拍照或从手机相册中选图接口</span>    
<button class="chooseImage" id="chooseImage">chooseImage</button>    
<span class="desc">预览图片接口</span>
<button class="previewImage" id="previewImage">previewImage</button>
<div class="preview" id="preview"></div>
<span class="desc">上传图片接口</span>    
<button class="uploadImage" id="uploadImage">uploadImage</button>    
<span class="desc">下载图片接口</span>    
<button class="downloadImage" id="downloadImage">downloadImage</button>
</div>    
</div>    
</body>    
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>    
<script>
	var formData = new FormData();
	formData.append("type","config");
	formData.append("url",location.href.split('#')[0]);

	var request = new XMLHttpRequest();
	request.open("POST","../weixin/jssdk.php");
	request.responseType = "json";
	request.onload = function()
	{
		if(request.readyState == 4 && request.status == 200)
		{
			wx.config({
				debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
				appId: this.response.appId, // 必填，公众号的唯一标识
				timestamp: this.response.timestamp, // 必填，生成签名的时间戳
				nonceStr: this.response.noncestr, // 必填，生成签名的随机串
				signature: this.response.signature,// 必填，签名，见附录1
				jsApiList: ['checkJsApi','chooseImage','previewImage','uploadImage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
			});
		}
	}
	request.send(formData);

	wx.ready(function(){
		// 判断当前版本是否支持指定的js接口，支持批量判断
		wx.checkJsApi({
			jsApiList:['checkJsApi','chooseImage','previewImage','uploadImage'],
			success:function(res){
			}
		});
		// var images = {
		// 	localIds:[],
		// 	serverIds:[]
		// };
		var localId;
		var serverId;
		document.querySelector('#chooseImage').onclick = function(){
			wx.chooseImage({
				count: 1, // 默认9
    			sizeType: ['original'], // 可以指定是原图还是压缩图，默认二者都有
    			// sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
    			// sizeType: ['original'],
    			// sourceType: ['album'],
				success:function(res){
					// console.log("res is :");
					// console.log(res);
					localId = res.localIds;
					// alert('已选择 ' + res.localIds.length + ' 张图片');
				}
			});
		};
		document.querySelector('#previewImage').onclick = function () {
			// wx.previewImage({
			// 	current: images.localIds ,
			// 	urls: images.localIds
			// });
			var ele = document.createElement("img");
			ele.src = localId.toString();
			var element = document.getElementById("preview");
			element.appendChild(ele);
		};
		document.querySelector('#uploadImage').onclick = function () {
			alert('确定上传？');
			if (localId.length == 0) {
				alert('请先上传图片');
				return;
			}
			wx.uploadImage({
				localId: localId.toString(),
				success: function (res) {
					alert('已上传');
					serverId = res.serverId;
					var request = new XMLHttpRequest();
					request.open("GET","../weixin/sid.php?sid="+ serverId.toString());
					// request.onload = function(){
					// 	if(request.readyState == 4 && request.status == 200){
					// 		if(this.response){
					// 			var a = this.response.toString();
					// 			alert(a);
					// 		}
					// 		else
					// 			alert("未收到后端反馈");
					// 	}
					// }
					request.send();
				},
				fail: function (res) {
					alert("未上传".JSON.stringify(res));
				}
			});
		};
	});
</script>
</html>